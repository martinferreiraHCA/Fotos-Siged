<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>SIGED - Fotos Estudiantiles</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="styles.css" />
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
  </head>
  <body>
    <header class="app-header">
      <div class="app-header__content">
        <div class="header-brand">
          <div class="header-icon" aria-hidden="true">ðŸ“¸</div>
          <div>
            <p class="eyebrow">SIGED</p>
            <h1>Fotos Estudiantiles</h1>
          </div>
        </div>

        <div class="header-user">
          <button id="btn-config-drive" class="btn-header-icon" title="Configurar Google Drive" aria-label="Configurar Google Drive">âš™</button>

          <button id="btn-login-google" class="btn-google">
            <svg width="16" height="16" viewBox="0 0 24 24" aria-hidden="true">
              <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
              <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
              <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
              <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
            </svg>
            <span>Conectar Drive</span>
          </button>

          <div id="user-info" class="user-info" hidden>
            <img id="user-avatar" class="user-avatar" src="" alt="Avatar" />
            <div class="user-details">
              <strong id="user-name"></strong>
              <span id="drive-status" class="drive-status">Drive conectado</span>
            </div>
            <button id="btn-logout-google" class="btn-header-sm">Salir</button>
          </div>
        </div>
      </div>
    </header>

    <main class="layout">
      <aside class="card sidebar">
        <h2 class="section-title">
          Informaci&oacute;n general
          <button class="help-btn" data-help="panel-info" aria-label="Ayuda sobre informaci&oacute;n">?</button>
        </h2>

        <div class="pill-row">
          <span class="pill">Grupo actual</span>
          <strong id="grupo-actual">No seleccionado</strong>
        </div>

        <ul class="stats-grid">
          <li>
            <span>Total</span>
            <strong id="stat-total">0</strong>
          </li>
          <li>
            <span>Con foto</span>
            <strong id="stat-con-foto">0</strong>
          </li>
          <li>
            <span>Pendientes</span>
            <strong id="stat-pendientes">0</strong>
          </li>
        </ul>

        <div class="progress-wrap">
          <label for="progress">Progreso del grupo</label>
          <progress id="progress" value="0" max="100"></progress>
        </div>

        <section class="mini-section">
          <h3 class="section-title section-title--small">
            &Uacute;ltima foto
            <button class="help-btn" data-help="ultima-foto" aria-label="Ayuda sobre &uacute;ltima foto">?</button>
          </h3>
          <canvas id="ultima-foto" width="150" height="150"></canvas>
          <p id="ultimo-estudiante">Ninguna foto tomada.</p>
        </section>

        <section class="mini-section">
          <h3 class="section-title section-title--small">Pendientes</h3>
          <ul id="pendientes" class="list compact"></ul>
        </section>

        <section class="mini-section sesion-panel">
          <h3 class="section-title section-title--small">Sesi&oacute;n guardada</h3>
          <p id="sesion-count" class="sesion-count">Sin fotos guardadas a&uacute;n</p>
          <p class="sesion-hint">Las fotos se guardan autom&aacute;ticamente en este navegador y se recuperan al recargar la p&aacute;gina.</p>
          <button id="btn-limpiar-sesion" class="btn-secondary btn-danger-soft" disabled>Limpiar sesi&oacute;n</button>
        </section>

        <section id="drive-panel" class="mini-section drive-panel" hidden>
          <h3 class="section-title section-title--small">Google Drive</h3>
          <div class="drive-path">
            <span class="drive-path-icon">&#128193;</span>
            <span id="drive-path-text" class="drive-path-text">No conectado</span>
          </div>
          <div class="drive-stats">
            <span id="drive-sync-count" class="drive-sync-count"></span>
          </div>
        </section>

        <section class="mini-section">
          <h3 class="section-title section-title--small">Reportes</h3>
          <div class="actions-col">
            <button id="btn-asistencia" class="btn-secondary">Lista de Asistencia</button>
            <button id="btn-estado" class="btn-secondary">Estado Actual</button>
            <button id="btn-todos" class="btn-secondary">Todos los Estudiantes</button>
          </div>
        </section>
      </aside>

      <section class="card main-panel">
        <section class="controls card-soft">
          <div class="controls-grid">
            <div class="field">
              <label for="camara">C&aacute;mara</label>
              <div class="field-inline">
                <select id="camara"></select>
                <button id="btn-activar">Activar c&aacute;mara</button>
                <button class="help-btn" data-help="activar-camara" aria-label="Ayuda para activar c&aacute;mara">?</button>
              </div>
            </div>

            <div class="field">
              <label for="csv-file">Archivo CSV local</label>
              <div class="field-inline">
                <input id="csv-file" type="file" accept=".csv,text/csv" />
                <button class="help-btn" data-help="cargar-csv" aria-label="Ayuda para cargar CSV">?</button>
              </div>
            </div>

            <div class="field field--full">
              <label for="csv-url">
                URL fija del CSV
                <span class="field-badge">Google Sheets &middot; GitHub Raw</span>
              </label>
              <div class="field-inline">
                <input id="csv-url" type="url" placeholder="https://docs.google.com/spreadsheets/d/..." />
                <button id="btn-cargar-url">Cargar URL</button>
                <button id="btn-olvidar-url" class="btn-secondary" title="Quitar URL guardada" hidden>âœ•</button>
                <button class="help-btn" data-help="cargar-url" aria-label="Ayuda para cargar desde URL">?</button>
              </div>
              <p id="url-status" class="field-status"></p>
            </div>

            <div class="field">
              <label for="grupo">Grupo</label>
              <div class="field-inline">
                <select id="grupo"></select>
                <button id="btn-seleccionar">Seleccionar grupo</button>
                <button class="help-btn" data-help="seleccionar-grupo" aria-label="Ayuda para seleccionar grupo">?</button>
              </div>
            </div>

            <div class="field">
              <label for="buscar">Buscar estudiante</label>
              <input id="buscar" type="text" placeholder="Nombre o documento" />
            </div>
          </div>
        </section>

        <!-- Student photo preview card -->
        <section id="student-preview" class="student-preview card-soft" hidden>
          <div class="sp-photo-wrap">
            <img id="sp-photo" class="sp-photo" src="" alt="Foto del estudiante" />
            <div class="sp-no-photo" id="sp-no-photo">Sin foto</div>
          </div>
          <div class="sp-info">
            <strong id="sp-name" class="sp-name"></strong>
            <span id="sp-doc" class="sp-doc"></span>
            <span id="sp-drive-status" class="sp-drive-badge" hidden></span>
          </div>
        </section>

        <section class="content">
          <article class="camera-block card-soft">
            <h3>Vista previa de c&aacute;mara</h3>
            <div class="camera-preview-wrap">
              <video id="preview" autoplay playsinline></video>
              <div id="crop-guide" class="crop-guide"></div>
            </div>
            <canvas id="captura" width="320" height="240" hidden></canvas>
            <div class="capture-area">
              <button id="btn-capturar" class="btn-capture">
                <span class="capture-icon">&#128247;</span>
                Capturar
              </button>
              <div class="camera-actions">
                <button id="btn-zip-inline" class="btn-secondary">Generar ZIP</button>
              </div>
            </div>
          </article>

          <article class="students-block card-soft">
            <h3>Lista de estudiantes</h3>
            <ul id="estudiantes" class="list"></ul>
          </article>
        </section>

        <footer class="actions-bar card-soft">
          <span id="estudiante-actual">Estudiante: Ninguno seleccionado</span>
          <div class="actions-end">
            <button id="btn-guardar" class="btn-success">Guardar foto</button>
            <button class="help-btn" data-help="guardar-foto" aria-label="Ayuda para guardar foto">?</button>
            <button id="btn-finalizar" class="btn-secondary">Generar ZIP</button>
            <button class="help-btn" data-help="comprimir" aria-label="Ayuda para comprimir grupo">?</button>
          </div>
        </footer>
      </section>
    </main>

    <!-- Mobile bottom toolbar -->
    <nav class="mobile-toolbar" aria-label="Acciones r&aacute;pidas">
      <button id="tb-activar" type="button">
        <span class="tb-icon">&#127909;</span>
        C&aacute;mara
      </button>
      <button id="tb-capturar" class="btn-tb-capture" type="button">
        <span class="tb-icon">&#128247;</span>
        Capturar
      </button>
      <button id="tb-guardar" type="button">
        <span class="tb-icon">&#128190;</span>
        Guardar
      </button>
      <button id="tb-zip" type="button">
        <span class="tb-icon">&#128230;</span>
        ZIP
      </button>
    </nav>

    <dialog id="help-modal">
      <article class="help-dialog">
        <h3 id="help-title">Ayuda</h3>
        <p id="help-body"></p>
        <form method="dialog">
          <button class="btn-secondary">Cerrar</button>
        </form>
      </article>
    </dialog>

    <dialog id="config-drive-modal">
      <article class="help-dialog config-drive-dialog">
        <h3>Configurar Google Drive</h3>
        <p>Para guardar las fotos en tu Drive necesitas un <strong>Client ID</strong> de Google Cloud Console. Solo se hace una vez.</p>

        <ol class="config-steps">
          <li>Ve a <a href="https://console.cloud.google.com/" target="_blank" rel="noopener">console.cloud.google.com</a></li>
          <li>Crea un proyecto &rarr; habilita <strong>Google Drive API</strong></li>
          <li>Credenciales &rarr; <strong>Crear credenciales &rarr; ID de cliente OAuth 2.0</strong></li>
          <li>Tipo: <strong>Aplicaci&oacute;n web</strong> &rarr; agrega tu dominio en "Or&iacute;genes de JS autorizados"</li>
          <li>Copia el <strong>Client ID</strong> y p&eacute;galo abajo</li>
        </ol>

        <div class="field" style="margin-top:.85rem">
          <label for="client-id-input">Client ID de Google</label>
          <input id="client-id-input" type="text" placeholder="xxxx.apps.googleusercontent.com" autocomplete="off" />
        </div>

        <div class="config-actions">
          <button type="button" id="btn-guardar-config-drive">Guardar y conectar</button>
          <form method="dialog" style="display:contents">
            <button class="btn-secondary">Cancelar</button>
          </form>
        </div>
      </article>
    </dialog>

    <div id="toast-container" aria-live="polite" aria-atomic="false"></div>

    <script type="module" src="app.js"></script>
  </body>
</html>
